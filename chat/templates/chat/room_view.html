{% load static %}
<!DOCTYPE html>
<html class="light-style">

<head>
    <title>Sala {{name}}</title>
    <link rel="icon" type="image/x-icon" href="{% static 'chat.ico' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css">

    <link rel="stylesheet" href="{% static 'css/app-chat.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/scrollbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">

    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>

<body>
    <!-- Content wrapper -->
    <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 pt-5">
            <a href="{% url 'chat:index_view' %}" class="btn btn-primary send-msg-btn">
                <i class='bx bxs-chevron-left me-md-1 me-0'></i>
                <!-- <i class='bx bxs-chevron-left-circle me-md-1 me-0'></i> -->
                <span class="align-middle d-md-inline-block d-none">Volver</span>
            </a>
            <a href="{% url 'chat:signoff' %}" class="btn btn-danger button-49 text-end" style="display: inline-block; text-align: center;text-decoration: none;">Cerrar Sesion</a>
            <!-- <button class="btn btn-primary d-flex send-msg-btn">
                <i class="bx bx-paper-plane me-md-1 me-0"></i>
                <span class="align-middle d-md-inline-block d-none">Send</span>
            </button> -->
            <h2>SALA: "{{name}}"</h2>
            <div>Slug: <span id="dashboard-slug">{{slug}}</span></div>
            <div>User: <span id="user">{{user}}</span></div>
        </div>
        <!-- Content -->
        <div class="container-xxl flex-grow-1 container-p-y">
            <div class="app-chat overflow-hidden card">
                <div class="row g-0">

                    <!-- Chat & Contacts -->
                    <div class="col app-chat-contacts app-sidebar flex-grow-0 overflow-hidden border-end" id="app-chat-contacts">
                        <div class="sidebar-header pt-3 px-3 mx-1">
                            <div class="d-flex align-items-center me-3 me-lg-0">
                                <!-- <div class="flex-shrink-0 avatar avatar-online me-2" data-bs-toggle="sidebar"
                                    data-overlay="app-overlay-ex" data-target="#app-chat-sidebar-left">
                                    <span class="avatar-initial rounded-circle bg-label-success">CM</span>
                                </div> -->
                                <h4 class="align-items-center">Usuarios en Chat</h4>
                                <!-- <div class="flex-grow-1 input-group input-group-merge rounded-pill ms-1">
                                    <span class="input-group-text" id="basic-addon-search31"><i
                                            class="bx bx-search fs-4"></i></span>
                                    <input type="text" class="form-control chat-search-input" placeholder="Search..."
                                        aria-label="Search..." aria-describedby="basic-addon-search31" />
                                </div> -->
                            </div>
                            <i class="bx bx-x cursor-pointer position-absolute top-0 end-0 mt-2 me-1 fs-4 d-lg-none d-block"
                                data-overlay data-bs-toggle="sidebar" data-target="#app-chat-contacts"></i>
                        </div>
                        <hr class="container-m-nx mt-3 mb-0" />
                        <div class="sidebar-body">
                            <!-- Chats -->
                            <ul class="list-unstyled chat-contact-list pt-1" id="chat-list">                                
                                <!-- <li class="chat-contact-list-item active">
                                    <a class="d-flex align-items-center">
                                        <div class="flex-shrink-0 avatar avatar-online">
                                            <span class="avatar-initial rounded-circle bg-label-success">CM</span>
                                        </div>
                                        <div class="chat-contact-info flex-grow-1 ms-3">
                                            <h6 class="chat-contact-name text-truncate m-0">
                                                Waldemar Mannering
                                            </h6>
                                            <p class="chat-contact-status text-truncate mb-0 text-muted">
                                                Refer friends. Get rewards.
                                            </p>
                                        </div>
                                        <small class="text-muted mb-auto">5 Minutes</small>
                                    </a>
                                </li>
                                <li class="chat-contact-list-item">
                                    <a class="d-flex align-items-center">
                                        <div class="flex-shrink-0 avatar avatar-offline">
                                            <span class="avatar-initial rounded-circle bg-label-success">CM</span>
                                        </div>
                                        <div class="chat-contact-info flex-grow-1 ms-3">
                                            <h6 class="chat-contact-name text-truncate m-0">
                                                Felecia Rower
                                            </h6>
                                            <p class="chat-contact-status text-truncate mb-0 text-muted">
                                                I will purchase it for sure. üëç
                                            </p>
                                        </div>
                                        <small class="text-muted mb-auto">30 Minutes</small>
                                    </a>
                                </li>
                                <li class="chat-contact-list-item">
                                    <a class="d-flex align-items-center">
                                        <div class="flex-shrink-0 avatar avatar-busy">
                                            <span class="avatar-initial rounded-circle bg-label-success">CM</span>
                                        </div>
                                        <div class="chat-contact-info flex-grow-1 ms-3">
                                            <h6 class="chat-contact-name text-truncate m-0">
                                                Calvin Moore
                                            </h6>
                                            <p class="chat-contact-status text-truncate mb-0 text-muted">
                                                If it takes long you can mail inbox user
                                            </p>
                                        </div>
                                        <small class="text-muted mb-auto">1 Day</small>
                                    </a>
                                </li> -->
                            </ul>
                        </div>
                    </div>
                    <!-- /Chat contacts -->

                    <!-- Chat History -->
                    <div class="col app-chat-history">
                        <div class="chat-history-wrapper">
                            <div class="chat-history-header border-bottom">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex overflow-hidden align-items-center">
                                        <i class="bx bx-menu bx-sm cursor-pointer d-lg-none d-block me-2"
                                            data-bs-toggle="sidebar" data-overlay data-target="#app-chat-contacts"></i>
                                        <div class="flex-shrink-0 avatar">
                                            <span class="avatar-initial rounded-circle bg-label-success">CP</span>
                                        </div>
                                        <div class="chat-contact-info flex-grow-1 ms-3">
                                            <h6 class="m-0">{{name}}</h6>
                                            <!-- <small class="user-status text-muted">NextJS developer</small> -->
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">                                        
                                    </div>
                                </div>
                            </div>
                            <div class="chat-history-body">
                                <ul class="list-unstyled chat-history mb-0" id="chatmenssage">
                                    {% if data %}
                                        {% for chat in data %}
                                        <li class="chat-message {% if chat.user == user %}chat-message-right{% endif %}">
                                            <div class="d-flex ove  rflow-hidden">
                                                {% if chat.user != user %}
                                                <div class="user-avatar flex-shrink-0 ms-3">
                                                    <div class="avatar avatar-sm">
                                                        <span class="avatar-initial rounded-circle bg-label-success">{{chat.user}}</span>
                                                    </div>
                                                </div>                                                
                                                {% endif %}
                                                <div class="chat-message-wrapper flex-grow-1">
                                                    <div class="chat-message-text">
                                                        <p class="mb-0">
                                                            {{chat.content}}
                                                        </p>
                                                    </div>
                                                    <div class="text-end text-muted mt-1">
                                                        <i class="bx bx-check-double text-success"></i>
                                                        <small>{{chat.timestamp}}</small>
                                                    </div>
                                                </div>
                                                {% if chat.user == user %}
                                                <div class="user-avatar flex-shrink-0 ms-3">
                                                    <div class="avatar avatar-sm">
                                                        <span class="avatar-initial rounded-circle bg-label-success">{{chat.user}}</span>
                                                    </div>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </li>
                                        {% endfor %}
                                    {% endif %}
                                    <!-- <li class="chat-message chat-message-right">
                                        <div class="d-flex ove  rflow-hidden">
                                            <div class="chat-message-wrapper flex-grow-1">
                                                <div class="chat-message-text">
                                                    <p class="mb-0">
                                                        How can we help? We're here for you! üòÑ
                                                    </p>
                                                </div>
                                                <div class="text-end text-muted mt-1">
                                                    <i class="bx bx-check-double text-success"></i>
                                                    <small>10:00 AM</small>
                                                </div>
                                            </div>
                                            <div class="user-avatar flex-shrink-0 ms-3">
                                                <div class="avatar avatar-sm">
                                                    <span class="avatar-initial rounded-circle bg-label-success">CM</span>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="chat-message">
                                        <div class="d-flex overflow-hidden">
                                            <div class="user-avatar flex-shrink-0 me-3">
                                                <div class="avatar avatar-sm">
                                                    <span class="avatar-initial rounded-circle bg-label-success">CM</span>
                                                </div>
                                            </div>
                                            <div class="chat-message-wrapper flex-grow-1">
                                                <div class="chat-message-text">
                                                    <p class="mb-0">
                                                        Hey John, I am looking for the best admin
                                                        template.
                                                    </p>
                                                    <p class="mb-0">
                                                        Could you please help me to find it out? ü§î
                                                    </p>
                                                </div>
                                                <div class="chat-message-text mt-2">
                                                    <p class="mb-0">
                                                        It should be Bootstrap 5 compatible.
                                                    </p>
                                                </div>
                                                <div class="text-muted mt-1">
                                                    <small>10:02 AM</small>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="chat-message chat-message-right">
                                        <div class="d-flex overflow-hidden">
                                            <div class="chat-message-wrapper flex-grow-1">
                                                <div class="chat-message-text">
                                                    <p class="mb-0">
                                                        Great, Feel free to get in touch.
                                                    </p>
                                                </div>
                                                <div class="text-end text-muted mt-1">
                                                    <i class="bx bx-check-double text-success"></i>
                                                    <small>10:10 AM</small>
                                                </div>
                                            </div>
                                            <div class="user-avatar flex-shrink-0 ms-3">
                                                <div class="avatar avatar-sm">
                                                    <img src="../../assets/img/avatars/1.png" alt="Avatar"
                                                        class="rounded-circle" />
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="chat-message">
                                        <div class="d-flex overflow-hidden">
                                            <div class="user-avatar flex-shrink-0 me-3">
                                                <div class="avatar avatar-sm">
                                                    <img src="../../assets/img/avatars/2.png" alt="Avatar"
                                                        class="rounded-circle" />
                                                </div>
                                            </div>
                                            <div class="chat-message-wrapper flex-grow-1">
                                                <div class="chat-message-text">
                                                    <p class="mb-0">
                                                        Do you have design files for Sneat?
                                                    </p>
                                                </div>
                                                <div class="text-muted mt-1">
                                                    <small>10:15 AM</small>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="chat-message chat-message-right">
                                        <div class="d-flex overflow-hidden">
                                            <div class="chat-message-wrapper flex-grow-1 w-50">
                                                <div class="chat-message-text">
                                                    <p class="mb-0">
                                                        Yes that's correct documentation file, Design
                                                        files are included with the template.
                                                    </p>
                                                </div>
                                                <div class="text-end text-muted mt-1">
                                                    <i class="bx bx-check-double"></i>
                                                    <small>10:15 AM</small>
                                                </div>
                                            </div>
                                            <div class="user-avatar flex-shrink-0 ms-3">
                                                <div class="avatar avatar-sm">
                                                    <img src="../../assets/img/avatars/1.png" alt="Avatar"
                                                        class="rounded-circle" />
                                                </div>
                                            </div>
                                        </div>
                                    </li> -->
                                </ul>
                            </div>
                            <!-- Chat message form -->
                            <div class="chat-history-footer">
                                <div class="form-send-message d-flex justify-content-between align-items-center">
                                    <input class="form-control message-input border-0 me-3 shadow-none"
                                        id="data-input" placeholder="Type your message here..." />
                                    <div class="message-actions d-flex align-items-center">                                        
                                        <button class="btn btn-primary d-flex send-msg-btn">
                                            <i class="bx bx-paper-plane me-md-1 me-0"></i>
                                            <span class="align-middle d-md-inline-block d-none" id="submit-btn">Send</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /Chat History -->                     
                </div>
            </div>
        </div>
        <!-- / Content -->
    </div>
    <!-- Content wrapper -->

    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'js/boostrap.js' %}"></script>
    <script src="{% static 'js/perfect-scrollbar.js' %}"></script>

    <script src="{% static 'js/chat.js' %}"></script>
    <script>
    //     document.addEventListener("DOMContentLoaded", function () {
    // // Tu c√≥digo aqu√≠
    //     const dashboarsSlug = document.getElementById('dashboard-slug').textContent.trim();
    //     const userDom = document.getElementById('user').textContent.trim();
    //     const submitBtn = document.getElementById('submit-btn');
    //     const dataInput = document.getElementById('data-input');
    //     const chatMenssage = document.getElementById('chatmenssage');
    //     const chatListUser = document.getElementById('chat-list');

        
    //     function connectToWebSocket() {
    //         const socket = new WebSocket(`ws://${window.location.host}/ws/view/${dashboarsSlug}/`);
    //         console.log(socket);
    //         // Manejar el evento onopen
    //         socket.onopen = function (e) {
    //             console.log("Successfully connected to the WebSocket.");
    //         };

    //         // socket.onclose = function (e) {
    //         //     console.log("WebSocket connection closed unexpectedly. Trying to reconnect in 2s...");
    //         //     setTimeout(function () {
    //         //         console.log("Reconnecting...");
    //         //         // Vuelve a conectar aqu√≠ llamando a la funci√≥n que establece la conexi√≥n.
    //         //         connectToWebSocket();
    //         //     }, 2000);
    //         // };
            
    //         socket.onmessage = function(e){
    //             const data = JSON.parse(e.data)
    //             switch (data.type) {
    //                 case "chat_message":
    //                     chatMenssage.innerHTML += `<li class="chat-message ${data.user === userDom ? 'chat-message-right' : ''}">
    //                                                     <div class="d-flex ove  rflow-hidden">  
    //                                                         ${data.user !== userDom ? '<div class="user-avatar flex-shrink-0 ms-3"><div class="avatar avatar-sm"><span class="avatar-initial rounded-circle bg-label-success">'+data.user+'</span></div></div>' : ''}
    //                                                         <div class="chat-message-wrapper flex-grow-1">
    //                                                             <div class="chat-message-text">
    //                                                                 <p class="mb-0">
    //                                                                     ${data.message}
    //                                                                 </p>
    //                                                             </div>
    //                                                             <div class="text-end text-muted mt-1">
    //                                                                 <i class="bx bx-check-double text-success"></i>
    //                                                                 <span class="time">hoy</span>
    //                                                             </div>
    //                                                         </div>
    //                                                         ${data.user === userDom ? '<div class="user-avatar flex-shrink-0 ms-3"><div class="avatar avatar-sm"><span class="avatar-initial rounded-circle bg-label-success">'+data.user+'</span></div></div>' : ''}
    //                                                     </div>
    //                                                 </li>`
    //                     break;
                        
    //                 case "user_join":
    //                     chatListUser.innerHTML = "";
    //                     for (var i = 0; i < data.user.length; i++) {
                            
    //                         chatListUser.innerHTML += `<li class="chat-contact-list-item" id="${data.user[i]}">
    //                                                         <a class="d-flex align-items-center">
    //                                                             <div class="flex-shrink-0 avatar avatar-online">
    //                                                                 <span class="avatar-initial rounded-circle bg-label-success">CM</span>
    //                                                             </div>
    //                                                             <div class="chat-contact-info flex-grow-1 ms-3">
    //                                                                 <h6 class="chat-contact-name text-truncate m-0">
    //                                                                     ${data.user[i]}
    //                                                                 </h6>
    //                                                             </div>
    //                                                         </a>
    //                                                     </li>`
    //                     }
    //                     break;

    //                 case "user_leave":
    //                     var elemento = document.getElementById(data.user);
    //                     elemento.parentNode.removeChild(elemento);
    //                     break;
                                    
    //                 default:
    //                     console.error("Unknown message type!");
    //                     break;
                
    //             }

    //         }

    //         submitBtn.addEventListener('click', () => {
    //             sendMessage();
    //         });

    //         dataInput.addEventListener('keydown', (e) => {
    //             if (e.key === "Enter") {
    //                 sendMessage();
    //             }
    //         });

    //         function sendMessage() {
    //             const dataValue = dataInput.value;
    //             const scrollbajo = document.querySelector(".list-unstyled");
    //             const nolo = document.querySelector(".chat-history-body");
    //             // Verificar si el campo de entrada est√° vac√≠o
    //             if (dataValue.trim() !== "") {
    //                 socket.send(JSON.stringify({
    //                     'message': dataValue,
    //                 }));
    //                 dataInput.value = "";
    //                 dataInput.focus();
    //                 setTimeout(() => {
    //                     scrollbajo.scrollTo(0, scrollbajo.scrollHeight);
    //                 }, 100);
    //                 // nolo.scrollTo(0, nolo.scrollHeight);
    //             }
    //         }
    //     }

    //     connectToWebSocket();
        
    // });

    </script>

</body>

</html>